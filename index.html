<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Op Art Generator V4 - Real Masking</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #111; /* 패턴이 잘 보이도록 어두운 배경 */
            color: #eee;
            font-family: sans-serif;
        }
        canvas {
            background: #fff; /* 캔버스 배경은 흰색 (옵아트 대비) */
            box-shadow: 0 0 30px rgba(0,0,0,0.7);
        }
        .controls {
            margin-top: 20px;
            text-align: center;
        }
        p { margin-bottom: 10px; color: #aaa; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="controls">
        <p>검은색 도형(JPG/PNG)을 올리면, 패턴이 그 모양이 됩니다.</p>
        </div>

    <script>
        let buffer; // 이미지를 분석할 투명한 메모리 공간
        let imgLoaded = false; // 이미지가 로드되었는지 확인
        
        // 설정값
        let gridSize = 10;      // 격자 크기
        let bulgeStrength = 2.0; // 볼록한 정도

        function setup() {
            let cnv = createCanvas(600, 600);
            cnv.parent(document.body);
            
            // [중요] 고해상도 모니터에서 좌표 꼬임 방지
            pixelDensity(1); 
            noSmooth();

            // 분석용 버퍼 생성 (화면과 똑같은 크기)
            buffer = createGraphics(600, 600);
            buffer.pixelDensity(1);

            // UI 배치
            let fileInput = createFileInput(handleFile);
            fileInput.parent(select('.controls'));

            // 초기 화면
            background(255);
            fill(0);
            textAlign(CENTER, CENTER);
            textSize(16);
            text("이미지 업로드 대기 중...", width/2, height/2);
            noLoop();
        }

        function draw() {
            if (imgLoaded) {
                background(255); // 흰색 배경

                // 버퍼의 픽셀 정보를 읽어옵니다.
                buffer.loadPixels();

                // 그리드 루프
                for (let y = 0; y < height; y += gridSize) {
                    for (let x = 0; x < width; x += gridSize) {
                        
                        let cx = x + gridSize / 2;
                        let cy = y + gridSize / 2;

                        // [핵심] 버퍼(buffer)에서 현재 위치(cx, cy)의 색을 가져옵니다.
                        let c = buffer.get(cx, cy);
                        
                        // 조건: 검은색(어두운) 픽셀인가? 
                        // (배경이 투명이면 alpha값으로, 흰색이면 brightness로 체크)
                        let isTarget = (alpha(c) > 50) && (brightness(c) < 200);

                        if (isTarget) {
                            // === 여기에 해당할 때만 패턴을 그립니다 ===
                            
                            // 왜곡 계산 (화면 중앙 기준)
                            let distFromCenter = dist(cx, cy, width/2, height/2);
                            let maxDist = width / 1.6;
                            
                            let factor = map(distFromCenter, 0, maxDist, 1, 0);
                            factor = constrain(factor, 0, 1);
                            let distortion = pow(factor, bulgeStrength);
                            
                            let currentSize = gridSize * distortion;
                            
                            // 체크보드 패턴
                            let colIndex = floor(x / gridSize);
                            let rowIndex = floor(y / gridSize);

                            fill(0);
                            noStroke();

                            // 짝수 칸에만 그림
                            if ((colIndex + rowIndex) % 2 == 0) {
                                rectMode(CENTER);
                                // 최소 크기 제한 (너무 작으면 지저분함)
                                if (currentSize > 0.5) {
                                    rect(cx, cy, currentSize, currentSize);
                                }
                            }
                        }
                        // isTarget이 아니면? 아예 그리지 않습니다 (흰색 배경 유지)
                    }
                }
                noLoop(); // 렌더링 후 멈춤
            }
        }

        function handleFile(file) {
            if (file.type === 'image') {
                loadImage(file.data, (img) => {
                    // 1. 버퍼 초기화 (이전 그림 지우기)
                    buffer.clear();
                    buffer.background(255); // 흰색 배경을 깔아줌 (JPG 처리용)
                    
                    // 2. 이미지 비율 맞춰서 버퍼 중앙에 그리기
                    let imgRatio = img.width / img.height;
                    let winRatio = width / height;
                    let dw, dh, dx, dy;

                    if (imgRatio > winRatio) {
                        dw = width;
                        dh = width / imgRatio;
                        dx = 0;
                        dy = (height - dh) / 2;
                    } else {
                        dw = height * imgRatio;
                        dh = height;
                        dx = (width - dw) / 2;
                        dy = 0;
                    }
                    
                    // 이미지를 버퍼에 그립니다. (화면에는 안 보임, 메모리에만 존재)
                    buffer.image(img, dx, dy, dw, dh);
                    
                    // 3. 그리기 시작 신호
                    imgLoaded = true;
                    loop(); 
                });
            }
        }
    </script>
</body>
</html>